# Copyright: (c) 2019, Hetzner Cloud GmbH <info@hetzner-cloud.de>
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)
---
- name: Test create with invalid firewall
  hetzner.hcloud.server:
    name: "{{ hcloud_server_name }}"
    firewalls:
      - invalid
    state: present
  ignore_errors: true
  register: result
- name: Verify create with invalid firewall
  ansible.builtin.assert:
    that:
      - result is failed
      - 'result.msg == "firewall invalid was not found"'

- name: Test create with firewall
  hetzner.hcloud.server:
    name: "{{ hcloud_server_name }}"
    server_type: cx11
    image: ubuntu-22.04
    firewalls:
      - "{{ test_firewall_1.hcloud_firewall.name }}"
    state: present
  register: result
- name: Verify create with firewall
  ansible.builtin.assert:
    that:
      - result is changed
      - result.hcloud_server.firewalls[0] == test_firewall_1.hcloud_firewall.name

- name: Test create with firewall idempotency
  hetzner.hcloud.server:
    name: "{{ hcloud_server_name }}"
    server_type: cx11
    image: ubuntu-22.04
    firewalls:
      - "{{ test_firewall_1.hcloud_firewall.name }}"
    state: present
  register: result
- name: Verify create with firewall idempotency
  ansible.builtin.assert:
    that:
      - result is not changed

- name: Test update with firewall
  hetzner.hcloud.server:
    name: "{{ hcloud_server_name }}"
    server_type: cx11
    image: ubuntu-22.04
    firewalls:
      - "{{ test_firewall_2.hcloud_firewall.name }}"
    state: present
  register: result
- name: Verify update with firewall
  ansible.builtin.assert:
    that:
      - result is changed
      - result.hcloud_server.firewalls[0] == test_firewall_2.hcloud_firewall.name

- name: Test update with firewall idempotency
  hetzner.hcloud.server:
    name: "{{ hcloud_server_name }}"
    server_type: cx11
    image: ubuntu-22.04
    firewalls:
      - "{{ test_firewall_2.hcloud_firewall.name }}"
    state: present
  register: result
- name: Verify update with firewall idempotency
  ansible.builtin.assert:
    that:
      - result is not changed

- name: Test delete with invalid firewall
  hetzner.hcloud.server:
    name: "{{ hcloud_server_name }}"
    state: absent
  register: result
- name: Verify delete with invalid firewall
  ansible.builtin.assert:
    that:
      - result is failed
